@model List<Milton.Models.Apps>

@{
    ViewBag.Title = "Home";

}

@section contents{
    <link href="~/Scripts/plugins/morris/morris.css" rel="stylesheet">
    <link href="~/Scripts/plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="~/Scripts/plugins/chartist/dist/chartist.min.css" rel="stylesheet">
}

<div class="row">
    <div class="col-sm-12">
        <div class="page-title-box">
            <h4 class="page-title">Bop General Report</h4>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <label class="control-label col-sm-4">Select the App</label>
        <div class="col-sm-8">
            <select id="AppSelect" class="form-control">
                @foreach (var val in Model)
                {
                    <option value="@val.Id">@val.Name</option>
                }
            </select>
        </div>
    </div>
</div>
<hr />
<div class="row">
    <div class="col-lg-12">
        <label class="control-label col-sm-4">Select the dates range</label>
        <div class="col-sm-8">
            <div class="input-daterange input-group" id="date-range">
                <span class="input-group-addon bg-primary b-0 text-white">Del</span>
                <input type="text" class="form-control fromDate" name="start">
                <span class="input-group-addon bg-primary b-0 text-white">Al</span>
                <input type="text" class="form-control toDate" name="end">
            </div>
        </div>
        <input type="submit" class="btn btn-primary" value="Generate Report" id="ss_btn" style="float: right; margin-top: 1pc; margin-bottom: 1pc;" onclick="GetInfo();" />
    </div>
</div>
<div class="row">
    <div class="col-sm-6 col-lg-3">
        <div class="widget-bg-color-icon card-box">
            <div class="bg-icon bg-icon-success pull-left">
                <i class="ti-unlock text-success"></i>
            </div>
            <div class="text-right">
                <h3 class="text-dark" id="l1"></h3>
                <p class="text-muted">Activations</p>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="widget-bg-color-icon card-box fadeInDown animated">
            <div class="bg-icon bg-icon-danger pull-left">
                <i class="ti-lock text-success"></i>
            </div>
            <div class="text-right">
                <h3 class="text-dark" id="l2">0</h3>
                <p class="text-muted">Cancellations</p>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="widget-bg-color-icon card-box">
            <div class="bg-icon bg-icon-inverse pull-left">
                <i class="ti-email text-info"></i>
            </div>
            <div class="text-right">
                <h3 class="text-dark" id="l3"></h3>
                <p class="text-muted">Subscribers</p>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="widget-bg-color-icon card-box">
            <div class="bg-icon bg-icon-warning pull-left">
                <i class="ti-money text-purple"></i>
            </div>
            <div class="text-right">
                <h3 class="text-dark" id="l4"></h3>
                <p class="text-muted">Charged</p>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="widget-bg-color-icon card-box">
            <div class="bg-icon bg-icon-purple pull-left">
                <i class="ti-user text-purple"></i>
            </div>
            <div class="text-right">
                <h3 class="text-dark" id="l5"></h3>
                <p class="text-muted">Registrations</p>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-8">
        <div class="card-box">
            <h4 class="text-dark  header-title m-t-0 m-b-30" id="titleCpMetrics">Metrics</h4>
            <div class="widget-chart text-center">
                <div id="simple-line-chart" style="height: 200px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-box">
            <h4 class="text-dark  header-title m-t-0 m-b-30">Subscribers by Company</h4>
            <div class="widget-chart text-center">
                <div id="morris-donut-example" style="height: 200px;">
                    <svg style="height: 200px; width: 100%" class="nvd3-svg"> </svg>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="card-box">
            <h4 class="text-dark  header-title m-t-0">Metrics Detail</h4>
            <div class="table-responsive">
                <table class="table" id="financialReport">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Activations</th>
                            <th>Cancellations</th>
                            <th>Subscribers</th>
                            <th>Charged</th>
                            <th>Registrations</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- end col -8 -->
@section scripts{
    <!-- Custom main Js -->
    <script src="~/Scripts/jquery.core.js"></script>
    <script src="~/Scripts/jquery.app.js"></script>

    <script src="@Url.Content("~/Scripts/plugins/moment/moment.js")"></script>
    <link href="~/Scripts/plugins/datatables/fixedHeader.bootstrap.min.css" rel="stylesheet" />
    <script src="~/Scripts/plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="~/Scripts/plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="~/Scripts/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
    <script src="@Url.Content("~/Scripts/plugins/d3/d3.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/nvd3/build/nv.d3.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/jquery.dataTables.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/dataTables.bootstrap.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/dataTables.buttons.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/buttons.bootstrap.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/jszip.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/pdfmake.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/vfs_fonts.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/buttons.html5.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/buttons.print.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/dataTables.fixedHeader.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/dataTables.keyTable.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/dataTables.responsive.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/responsive.bootstrap.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/datatables/dataTables.scroller.min.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/chartist/dist/chartist.min.js")"></script>







    <script type="text/javascript">
        $(document).ready(
            function ($) {
                const df = new Date();
                const dt = new Date();
                const asdF = (df.getMonth() + 1) + '-' + df.getDate() + '-' + df.getFullYear();
                const asdT = (df.getMonth() + 1) + '-' + df.getDate() + '-' + df.getFullYear();
                $('.fromDate').val(asdF);
                $('.toDate').val(asdT);
                $('#date-range').datepicker({
                    toggleActive: true,
                    dateFormat: 'yyyy/MM/dd',
                    language: 'en'
                });
                GetInfo();

            });

        function GetInfo() {
            const df = new Date($('.fromDate').val());
            const dt = new Date($('.toDate').val());
            const asdF = df.getFullYear() + '-' + (df.getMonth() + 1) + '-' + df.getDate();
            const asdT = dt.getFullYear() + '-' + (dt.getMonth() + 1) + '-' + dt.getDate();

            $.ajax({
                url: "/Home/acti?appId=" + $('#AppSelect').val() + "&initialDate=" + asdF + "&endDate=" + asdT,
                success: function (data) {

                    $("#l1").html("<b class='counter'>" + data.ActiveUsers + "</b>");
                    $("#l3").html("<b class='counter'>" + data.SubcribedUsers + "</b>");
                    $("#l4").html("<b class='counter'>" + data.Charged + "</b>");
                    $("#l5").html("<b class='counter'>" + data.Registered + "</b>");

                    $('#titleCpMetrics').html($('#AppSelect option:selected').text() + ' Metrics');
                    //Graph table
                    if (data.ReportGeneral.length > 0) {
                        var tbOne = $("#financialReport");
                        var columns = [
                            { data: 'Date', className: "left" },
                            { data: 'Suscripciones', className: "center" },
                            { data: 'Cancelados', className: "center" },
                            { data: 'Suscripciones', className: "center" },
                            { data: 'daily_charged', className: "center" },
                            { data: 'Registrados', className: "center" },

                        ];

                        tbOne.DataTable({
                            columns: columns,
                            data: data.ReportGeneral,
                            buttons: [{
                                extend: "excel",
                                className: "btn-sm"
                            }, {
                                extend: "pdf",
                                className: "btn-sm"
                            }],
                            dom: "Bfrtip",
                            responsive: !0
                        });
                        tbOne.find('tbody').empty();
                    }

                    //Graph Pie
                    nv.addGraph(function () {
                        var chart = nv.models.pieChart()
                            .x(function (d) { return d.label })
                            .y(function (d) { return d.value })
                            .showLabels(true);
                        d3.select("#morris-donut-example svg")
                            .datum(ConvertToData(data.CompaniesMetrics))
                            .transition().duration(1200)
                            .call(chart);

                        return chart;
                    });

                    //Graph Line
                    var labels = [];
                    var series = [];
                    for (var i = 0; i < data.ValuesPerMonth.length; i++) {
                        var val = data.ValuesPerMonth[i];
                        labels.push(val.MonthName);
                    }
                    var arr = [];
                    for (var i = 0; i < data.ValuesPerMonth.length; i++) {
                        var val = data.ValuesPerMonth[i];
                        arr.push(val.Activation);
                    }
                    series.push(arr);
                    arr = [];
                    for (var i = 0; i < data.ValuesPerMonth.length; i++) {
                        var val = data.ValuesPerMonth[i];
                        arr.push(val.Cancellation);
                    }
                    series.push(arr);
                    arr = [];
                    for (var i = 0; i < data.ValuesPerMonth.length; i++) {
                        var val = data.ValuesPerMonth[i];
                        arr.push(val.Subscription);
                    }
                    series.push(arr);
                    new Chartist.Line('#simple-line-chart', {
                        labels: labels,
                        series: series
                    }, {
                        fullWidth: true
                    });
                },
                error: function (xhr) {
                    debugger;
                },
                type: "GET",
                dataType: 'json',
                contentType: "application/json; charset=utf-8"
            });
            var getColor = function (type) {
                var color = generateColor();
                return color;
            }
            var generateColor = function () {
                return "#" + Math.floor(Math.random() * 16777215).toString(16);
            }
            function ConvertToData(info) {
                var rtn = [];
                $.each(info, function (i, j) {
                    rtn.push({
                        "label": j.Name,
                        "value": j.Value,
                        "color": getColor()
                    });
                });
                return rtn;
            }

        }

    </script>
}
